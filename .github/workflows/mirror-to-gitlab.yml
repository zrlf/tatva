name: Mirror to GitLab (SSH)

on:
  push:
    branches:
      - "**"
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # full history for current branch
          fetch-tags: true

      - name: Fetch all branches and tags from origin
        run: |
          # Fetch all branches and tags explicitly from GitHub
          git fetch origin "+refs/heads/*:refs/heads/*" --prune
          git fetch origin --tags --prune

      - name: Set up SSH for GitLab
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          install -m 700 -d ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan gitlab.ethz.ch >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      - name: Configure Git identity
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Push branches and tags to GitLab
        env:
          GIT_SSH_COMMAND: "ssh -i ~/.ssh/id_ed25519"
        run: |
          # Use your actual GitLab path here
          git remote add mirror git@gitlab.ethz.ch:smec/tatva-mirror.git

          # Push all branches (refs/heads/*), pruning deleted ones
          git push mirror --prune --all

          # Push all tags, pruning deleted ones
          git push mirror --prune --tags
