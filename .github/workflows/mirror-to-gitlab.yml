name: Mirror to GitLab (bare mirror, SSH)

on:
  push:
    branches:
      - '**'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Set up SSH for GitLab
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          install -m 700 -d ~/.ssh

          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

          ssh-keyscan gitlab.ethz.ch >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      - name: Create bare mirror of GitHub repo
        env:
          # GitHub provides this automatically; no need to define a secret
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN || github.token }}
        run: |
          # Use a bare repo so we don't have a checked-out branch
          git init --bare mirror.git
          cd mirror.git

          # Add GitHub as origin, authenticated with the workflow token
          git remote add origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git"

          # Fetch ALL branches into refs/heads/* and ALL tags into refs/tags/*
          git fetch origin \
            '+refs/heads/*:refs/heads/*' \
            '+refs/tags/*:refs/tags/*' \
            --prune

      - name: Push mirror to GitLab
        env:
          GIT_SSH_COMMAND: "ssh -i ~/.ssh/id_ed25519"
        run: |
          cd mirror.git

          # Add GitLab mirror remote
          git remote add gitlab git@gitlab.ethz.ch:smec/tatva-mirror.git

          # Mirror EVERYTHING:
          # - All branches (refs/heads/*)
          # - All tags (refs/tags/*)
          # - Delete refs on GitLab that no longer exist here
          git push gitlab --mirror
