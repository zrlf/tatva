name: Mirror to GitLab (SSH)

on:
  push:
    branches:
      - "**"
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # full history for the checked-out branch
          fetch-tags: true

      - name: Fetch all branches and tags from origin
        run: |
          # Update remote-tracking branches and tags from GitHub (origin)
          git fetch origin --prune --tags

      - name: Set up SSH for GitLab
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          install -m 700 -d ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan gitlab.ethz.ch >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      - name: Configure Git identity
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Push branches and tags to GitLab
        env:
          GIT_SSH_COMMAND: "ssh -i ~/.ssh/id_ed25519"
        run: |
          # Make sure we don't fail if the remote already exists
          git remote remove mirror 2>/dev/null || true

          # Use your actual GitLab path here
          git remote add mirror git@gitlab.ethz.ch:smec/tatva-mirror.git

          # Push all branches:
          #   take origin/* (remote-tracking branches) and map them to heads/* on GitLab
          git push mirror --prune 'refs/remotes/origin/*:refs/heads/*'

          # Push all tags
          git push mirror --prune --tags
